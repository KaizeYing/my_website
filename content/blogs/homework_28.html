---
title: "Session 4: Homework 2"
author: "Study Group A9, Members: Kaize Ying, Arman Topchu, Yiyue Hu, Leonie Bick, Lorenz Freigassner, Tafadzwa Chinanzvavana, Vrinda Gupta"
date: "2021-10-19"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="excess-rentals-in-tfl-bike-sharing" class="section level1">
<h1>Excess rentals in TfL bike sharing</h1>
<p>Recall the TfL data on how many bikes were hired every single day. We can get the latest data by running the following</p>
<pre class="r"><code>url &lt;- &quot;https://data.london.gov.uk/download/number-bicycle-hires/ac29363e-e0cb-47cc-a97a-e216d900a6b0/tfl-daily-cycle-hires.xlsx&quot;

# Download TFL data to temporary file
httr::GET(url, write_disk(bike.temp &lt;- tempfile(fileext = &quot;.xlsx&quot;)))</code></pre>
<pre><code>## Response [https://airdrive-secure.s3-eu-west-1.amazonaws.com/london/dataset/number-bicycle-hires/2021-09-23T12%3A52%3A20/tfl-daily-cycle-hires.xlsx?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAJJDIMAIVZJDICKHA%2F20211019%2Feu-west-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20211019T144520Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=1fb4b8fffe18fdb413c9f8511435f1577ea159caba980c0a14130398857ecce5&amp;X-Amz-SignedHeaders=host]
##   Date: 2021-10-19 14:45
##   Status: 200
##   Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
##   Size: 174 kB
## &lt;ON DISK&gt;  /var/folders/lz/qndgy3_954xcksqrq427ld7w0000gn/T//RtmpX0dgmA/file186c344555ed.xlsx</code></pre>
<pre class="r"><code># Use read_excel to read it as dataframe
bike0 &lt;- read_excel(bike.temp,
                   sheet = &quot;Data&quot;,
                   range = cell_cols(&quot;A:B&quot;))

# change dates to get year, month, and week
bike &lt;- bike0 %&gt;% 
  clean_names() %&gt;% 
  dplyr::rename (bikes_hired = number_of_bicycle_hires) %&gt;% 
  mutate (year = year(day),
          month = lubridate::month(day, label = TRUE),
          week = isoweek(day))</code></pre>
<p>We can easily create a facet grid that plots bikes hired by month and year.</p>
<pre class="r"><code>knitr::include_graphics(here::here(&quot;images&quot;, &quot;tfl_distributions_monthly.png&quot;), error = FALSE)</code></pre>
<p><img src="/Users/kaizeying/Desktop/LBS MT 21/my_website/images/tfl_distributions_monthly.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Look at May and Jun and compare 2020 with the previous years. What’s happening?</p>
<p>However, the challenge I want you to work on is to reproduce the following two graphs.</p>
<pre class="r"><code>knitr::include_graphics(here::here(&quot;images&quot;, &quot;tfl_monthly.png&quot;), error = FALSE)</code></pre>
<p><img src="/Users/kaizeying/Desktop/LBS MT 21/my_website/images/tfl_monthly.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>library(stringr)
library(ggplot2)
library(lubridate)
bike1 &lt;- bike %&gt;% 
  mutate(date=ymd(day),MON=month(date,label=TRUE)) %&gt;%
  filter(year&gt;=2016 &amp; year &lt;=2019)  %&gt;%
  dplyr::group_by(MON) %&gt;%
  dplyr::summarize(monthly_mean_peryear=mean(bikes_hired)) 



bike2 &lt;- bike %&gt;%
  mutate(date=ymd(day),MON=month(date,label=TRUE)) %&gt;%
  filter(year&gt;=2016)  %&gt;%
  dplyr::group_by(MON,year) %&gt;%
  dplyr::summarize(actual_month_rental=mean(bikes_hired))

 bike3 &lt;- dplyr::left_join(bike1, bike2, by =&quot;MON&quot;)

 bike4 &lt;- bike3 %&gt;%
  mutate(delta_rental= actual_month_rental-monthly_mean_peryear,MON=as.numeric(MON)) 

months &lt;- c(&quot;Jan&quot;,&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,&quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;)


bike4 %&gt;%
  ggplot(aes(x=MON)) +
  geom_line(aes(y=actual_month_rental),colour=&quot;black&quot;,size=0.3)+
  geom_line(aes(y=monthly_mean_peryear),colour=&quot;blue3&quot;,size=1)+
  facet_wrap(~year,nrow=2)+
    labs(title = &quot;Monthly changes in TfL bike rentals&quot;, 
    subtitle = &quot;change from monthly average shown in blue and calculated between 2016-2019&quot;,   caption= &quot;Source: TfL, London Data Store&quot;,
    x=&quot;Month&quot;, 
    y=&quot;Bike Rentals&quot; ) +
  theme_bw()+
   scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8,9,10,11,12),
                   labels=months)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=monthly_mean_peryear,ymax=monthly_mean_peryear+ifelse(actual_month_rental&gt;monthly_mean_peryear, actual_month_rental-monthly_mean_peryear, 0)),fill=&quot;green&quot;,alpha=0.25)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=monthly_mean_peryear,ymax=monthly_mean_peryear+ifelse(actual_month_rental&gt;monthly_mean_peryear, 0,actual_month_rental-monthly_mean_peryear)),fill=&quot;red&quot;,alpha=0.25) +
   theme(panel.background = element_rect(colour=&quot;white&quot;,fill=&quot;white&quot;), plot.background = element_rect(colour=&quot;black&quot;))+
  theme_minimal() +
   NULL</code></pre>
<p><img src="/blogs/homework_28_files/figure-html/tfl_absolute_monthly_change-2.png" width="100%" style="display: block; margin: auto;" /></p>
<p>The second one looks at percentage changes from the expected level of weekly rentals. The two grey shaded rectangles correspond to the second (weeks 14-26) and fourth (weeks 40-52) quarters.</p>
<pre class="r"><code>knitr::include_graphics(here::here(&quot;images&quot;, &quot;tfl_weekly.png&quot;), error = FALSE)</code></pre>
<p><img src="/Users/kaizeying/Desktop/LBS MT 21/my_website/images/tfl_weekly.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>bike5 &lt;- bike %&gt;% 
  mutate(date=ymd(day),WEEK=isoweek(date)) %&gt;%
  filter(year&gt;=2016 &amp; year &lt;=2019)  %&gt;%
  dplyr::group_by(WEEK) %&gt;%
  dplyr::summarize(weekly_mean_peryear=mean(bikes_hired)) 

bike6 &lt;- bike %&gt;%
  mutate(date=ymd(day),WEEK=isoweek(date)) %&gt;%
  filter(year&gt;=2016)  %&gt;%
  dplyr::group_by(WEEK,year) %&gt;%
  dplyr::summarize(actual_week_rental=mean(bikes_hired))

bike7 &lt;- left_join(bike5, bike6, by =&quot;WEEK&quot;)
bike8 &lt;- bike7 %&gt;%
  mutate(percentage_change=actual_week_rental/weekly_mean_peryear-1)


bike9 &lt;- head(bike8,-1) #cleaning week 53 of 2021 (outlier)
  
bike9 %&gt;%
  ggplot(aes(x=WEEK,y=percentage_change)) +
  geom_line(colour=&quot;black&quot;,size=0.3)+
  facet_wrap(~year,nrow=2)+
    labs(title = &quot;Weekly changes in Tfl bike rentals&quot;, 
    subtitle = &quot;% change from weekly averages calculated between 2016-2019&quot;,   caption= &quot;Source: TfL, London Data Store&quot;,
    x=&quot;week&quot;, 
    y=&quot;&quot; ) +
  
  theme_bw()+
  
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),breaks = seq(-0.5, 1, by = 0.5))+
  scale_x_continuous(breaks=c(13,26,39,53))+
  
 geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change&gt;0, percentage_change-0, 0)),fill=&quot;green&quot;,alpha=0.4)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change&gt;0, 0,percentage_change-0)),fill=&quot;red&quot;,alpha=0.4) +
  
  geom_rug(sides=&quot;b&quot;,alpha=0.5, color=ifelse(bike9$actual_week_rental &gt; bike9$weekly_mean_peryear, &quot;green&quot;, &quot;red&quot;))+
  
  annotate(&quot;rect&quot;, xmin = 14, xmax = 26, ymin = -1, ymax = 1, fill = &quot;grey&quot;, alpha=0.25) +
  annotate(&quot;rect&quot;, xmin = 40, xmax = 52,ymin = -1, ymax = 1, fill = &quot;grey&quot;,alpha=0.25) +
  
  theme(panel.background = element_rect(colour=&quot;white&quot;,fill=&quot;white&quot;), plot.background = element_rect(colour=&quot;black&quot;))+
  theme_minimal() +
   NULL</code></pre>
<p><img src="/blogs/homework_28_files/figure-html/tfl_percent_change-2.png" width="100%" style="display: block; margin: auto;" /></p>
<p>For both of these graphs, you have to calculate the expected number of rentals per week or month between 2016-2019 and then, see how each week/month of 2020-2021 compares to the expected rentals. Think of the calculation <code>excess_rentals = actual_rentals - expected_rentals</code>.</p>
<p>Should you use the mean or the median to calculate your expected rentals? Why?</p>
<p>In creating your plots, you may find these links useful:</p>
<ul>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="uri">https://ggplot2.tidyverse.org/reference/geom_ribbon.html</a></li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="uri">https://ggplot2.tidyverse.org/reference/geom_tile.html</a></li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="uri">https://ggplot2.tidyverse.org/reference/geom_rug.html</a></li>
</ul>
</div>
<div id="how-has-the-cpi-and-its-components-changed-over-the-last-few-years" class="section level1">
<h1>How has the CPI and its components changed over the last few years?</h1>
<div id="getting-the-data" class="section level2">
<h2>Getting the data</h2>
<pre class="r"><code>#Installing packages

library(rvest) # to scrape website
library(tidyquant)

#Getting the tables from the website

url &lt;- &quot;https://fredaccount.stlouisfed.org/public/datalist/843&quot;
tables &lt;- url %&gt;% 
  read_html() %&gt;% 
  html_nodes(css=&quot;table&quot;)

CPI_data_1 &lt;- map(tables, . %&gt;% 
             html_table(fill=TRUE)%&gt;% 
             janitor::clean_names())

CPI_data_2 &lt;- CPI_data_1[[2]] %&gt;% 
  slice(1:49)

#Pulling a vector of components via series_id

series_ids &lt;- CPI_data_2 %&gt;% 
  pull(series_id) 

#Getting the data from 01-01-2015 as chart starts from 2016 onwards 

CPI_data_3 &lt;- tidyquant::tq_get(series_ids, get = &quot;economic.data&quot;, from =  &quot;2015-01-01&quot;)
head(CPI_data_3)</code></pre>
<pre><code>## # A tibble: 6 × 3
##   symbol         date       price
##   &lt;chr&gt;          &lt;date&gt;     &lt;dbl&gt;
## 1 CUSR0000SETG01 2015-01-01  295.
## 2 CUSR0000SETG01 2015-02-01  294.
## 3 CUSR0000SETG01 2015-03-01  291.
## 4 CUSR0000SETG01 2015-04-01  285.
## 5 CUSR0000SETG01 2015-05-01  293.
## 6 CUSR0000SETG01 2015-06-01  299.</code></pre>
<p><strong>Note:</strong> While we were asked to download data from 01-01-2000 onward, we decided to only download the data needed to represent the same period as in the original graph, i.e., data from 01-01-2015 onward.</p>
</div>
<div id="modifying-the-data" class="section level2">
<h2>Modifying the data</h2>
<pre class="r"><code># Keeping only the important categories 

# All Items (100%)          = CPIAUCSL
# Housing (42%)             = CPIHOSSL
# Transport (15%)           = CPITRNSL
# Food and Beverages (15%)  = CPIFABSL
# Apparel (3%)              = CPIAPPSL

important_categories &lt;-c(&quot;CPIAUCSL&quot;, &quot;CPIHOSSL&quot;, &quot;CPITRNSL&quot;, &quot;CPIFABSL&quot;, &quot;CPIAPPSL&quot;)

CPI_data_4 &lt;- CPI_data_3 %&gt;%
  filter(symbol %in% important_categories)  

# Adding a lagged column and removing the resulting NAs

CPI_data_5 &lt;- CPI_data_4 %&gt;%
  group_by(symbol) %&gt;%
  dplyr::mutate(year_change = price/dplyr::lag(price, 12,default = NA) - 1) %&gt;%
  dplyr::filter(year_change != &quot;NA&quot;) %&gt;%
  as.data.frame()

# Adding direction of price changes for coloring points later on

CPI_data_6 &lt;- CPI_data_5 %&gt;%
  dplyr::mutate(change_sign = ifelse(year_change &gt;= 0, &quot;positive&quot;, &quot;negative&quot;))

# Adding the names of the series to the dataframe 

CPI_data_7 &lt;- CPI_data_6 %&gt;%
  dplyr::mutate(titles = case_when(symbol == &quot;CPIAUCSL&quot; ~ &quot;All Items&quot;, 
                               symbol == &quot;CPIHOSSL&quot; ~ &quot;Housing&quot;,
                               symbol == &quot;CPITRNSL&quot; ~ &quot;Transport&quot;,
                               symbol == &quot;CPIFABSL&quot; ~ &quot;Food and Beverages&quot;,
                               symbol == &quot;CPIAPPSL&quot; ~ &quot;Apparel&quot;)
                )

# Sorting the data according to the magnitude of yearly changes 

CPI_data_8 &lt;- CPI_data_7 %&gt;%
  mutate(titles = factor(titles,levels=c(&quot;All Items&quot;,&quot;Transport&quot;,&quot;Apparel&quot;,&quot;Food and Beverages&quot;,&quot;Housing&quot;)))
head(CPI_data_8)</code></pre>
<pre><code>##     symbol       date price year_change change_sign    titles
## 1 CPIAUCSL 2016-01-01   238     0.01238    positive All Items
## 2 CPIAUCSL 2016-02-01   237     0.00847    positive All Items
## 3 CPIAUCSL 2016-03-01   238     0.00892    positive All Items
## 4 CPIAUCSL 2016-04-01   239     0.01173    positive All Items
## 5 CPIAUCSL 2016-05-01   240     0.01078    positive All Items
## 6 CPIAUCSL 2016-06-01   240     0.01079    positive All Items</code></pre>
<p><strong>Notes</strong>: The St Louis Fed did not provide CPI data for the following major categories listed by the Bureau of Labour Statistics: Medical Care, Education and Communication as well as Recreation.</p>
<p>Moreover, as discussed over Slack, we needed to manually add the titles to the dataframe as we weren’t able to pull the titles from the website.</p>
</div>
<div id="plotting-the-data" class="section level2">
<h2>Plotting the data</h2>
<pre class="r"><code>CPI_data_8 %&gt;%
  ggplot(aes(x = date, y = year_change, col=change_sign))+
  geom_point(alpha=0.8)+
  geom_smooth(col=&quot;grey&quot;, se=F)+
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(&quot;titles&quot;, ncol = 3, scales = &quot;free&quot;) + 
  theme_bw() + 
  theme(legend.position= &quot;none&quot;, plot.title = element_text(face = &quot;bold&quot;))+
  scale_colour_manual(values = c(&quot;positive&quot; = &quot;lightcoral&quot;, &quot;negative&quot; = &quot;steelblue2&quot;))+
  labs(
    title = &quot;Yearly change of US CPI and its most important components&quot;,
    subtitle = &quot;YoY change, positive when red and negative when blue
Jan 2016 to Aug 2021&quot;,
    caption = &quot;Data from St. Louis Fed FRED 
    https://fredaccount.stlouisfed.org/public/datalist/843&quot;,
    x = &quot;&quot;,
    y = &quot;YoY % Change&quot;
  )+
  NULL</code></pre>
<p><img src="/blogs/homework_28_files/figure-html/plotting%20the%20data-1.png" width="648" style="display: block; margin: auto;" /></p>
<p><strong>Note</strong>: We were trying to color the words ‘positive’ and ‘negative’ in the subtitle but did not manage, even after installing ggtext and copying the code posted on Slack.</p>
</div>
</div>
<div id="details" class="section level1">
<h1>Details</h1>
<ul>
<li><p>Who did you collaborate with: <strong>Arman Topchu, Kaize Ying, Leonie Bick, Lorenz Freigassner, Tafadzwa Chinanzvavana, Yiyue Hu, Vrinda Gupta</strong></p></li>
<li><p>Approximately how much time did you spend on this problem set: <strong>XXX</strong></p></li>
<li><p>What, if anything, gave you the most trouble: <strong>XXX</strong>*</p></li>
</ul>
</div>
