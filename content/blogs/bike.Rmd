---
title: "Bike"
author: "LBS MFA2022 Study Group A9, Members: Kaize Ying, Arman Topchu, Yiyue Hu, Leonie Bick, Lorenz Freigassner, Tafadzwa Chinanzvavana, Vrinda Gupta"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---


```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r load-libraries, include=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(stringr)
library(skimr)
library(dplyr)
library(infer)
```

# Excess rentals in TfL bike sharing

## Downloading Tfl data and fixing dates

```{r, get_tfl_data, cache=TRUE}
url <- "https://data.london.gov.uk/download/number-bicycle-hires/ac29363e-e0cb-47cc-a97a-e216d900a6b0/tfl-daily-cycle-hires.xlsx"

# Download TFL data to temporary file
httr::GET(url, write_disk(bike.temp <- tempfile(fileext = ".xlsx")))

# Use read_excel to read it as dataframe
bike0 <- read_excel(bike.temp,
                   sheet = "Data",
                   range = cell_cols("A:B"))

# change dates to get year, month, and week
bike <- bike0 %>% 
  clean_names() %>% 
  dplyr::rename (bikes_hired = number_of_bicycle_hires) %>% 
  mutate (year = year(day),
          month = lubridate::month(day, label = TRUE),
          week = isoweek(day))
```


## Look at May and Jun and compare 2020 with the previous years. What's happening?

**Answer: In years 2015 to 2019, we can observe that the Bike Rentals in London see a sharp increase from previous months, depicted by sharp peaks in the monthly graphs above. This is probably because May and June are pleasant summer months in London, and that is when people like cycling the most, so they rent more bikes. However, we see that May and June in 2020 have flat slope graphs. This could be because of the COVID pandemic and the ban on travel by the UK government during the several lock downs.**

## Plotting the monthly changes in TfL bike rentals

```{r tfl_absolute_monthly_change, out.width="100%"}

library(stringr)
library(ggplot2)
library(lubridate)
bike1 <- bike %>% 
  mutate(date=ymd(day),MON=month(date,label=TRUE)) %>%
  filter(year>=2016 & year <=2019)  %>%
  dplyr::group_by(MON) %>%
  dplyr::summarize(monthly_mean_peryear=mean(bikes_hired)) 



bike2 <- bike %>%
  mutate(date=ymd(day),MON=month(date,label=TRUE)) %>%
  filter(year>=2016)  %>%
  dplyr::group_by(MON,year) %>%
  dplyr::summarize(actual_month_rental=mean(bikes_hired))

 bike3 <- dplyr::left_join(bike1, bike2, by ="MON")

 bike4 <- bike3 %>%
  mutate(delta_rental= actual_month_rental-monthly_mean_peryear,MON=as.numeric(MON)) 

months <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")


bike4 %>%
  ggplot(aes(x=MON)) +
  geom_line(aes(y=actual_month_rental),colour="black",size=0.3)+
  geom_line(aes(y=monthly_mean_peryear),colour="blue3",size=1)+
  facet_wrap(~year,nrow=2)+
    labs(title = "Monthly changes in TfL bike rentals", 
    subtitle = "change from monthly average shown in blue and calculated between 2016-2019",   caption= "Source: TfL, London Data Store",
    x="Month", 
    y="Bike Rentals" ) +
  theme_bw()+
   scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8,9,10,11,12),
                   labels=months)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=monthly_mean_peryear,ymax=monthly_mean_peryear+ifelse(actual_month_rental>monthly_mean_peryear, actual_month_rental-monthly_mean_peryear, 0)),fill="green",alpha=0.25)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=monthly_mean_peryear,ymax=monthly_mean_peryear+ifelse(actual_month_rental>monthly_mean_peryear, 0,actual_month_rental-monthly_mean_peryear)),fill="red",alpha=0.25) +
   theme(panel.background = element_rect(colour="white",fill="white"), plot.background = element_rect(colour="black"))+
  theme_minimal() +
   NULL
```

## Plotting percentage changes from the expected level of weekly rentals

```{r tfl_percent_change, out.width="100%"}

bike5 <- bike %>% 
  mutate(date=ymd(day),WEEK=isoweek(date)) %>%
  filter(year>=2016 & year <=2019)  %>%
  dplyr::group_by(WEEK) %>%
  dplyr::summarize(weekly_mean_peryear=mean(bikes_hired)) 

bike6 <- bike %>%
  mutate(date=ymd(day),WEEK=isoweek(date)) %>%
  filter(year>=2016)  %>%
  dplyr::group_by(WEEK,year) %>%
  dplyr::summarize(actual_week_rental=mean(bikes_hired))

bike7 <- left_join(bike5, bike6, by ="WEEK")
bike8 <- bike7 %>%
  mutate(percentage_change=actual_week_rental/weekly_mean_peryear-1)


bike9 <- head(bike8,-1) #cleaning week 53 of 2021 (outlier)
  
bike9 %>%
  ggplot(aes(x=WEEK,y=percentage_change)) +
  geom_line(colour="black",size=0.3)+
  facet_wrap(~year,nrow=2)+
    labs(title = "Weekly changes in Tfl bike rentals", 
    subtitle = "% change from weekly averages calculated between 2016-2019",   caption= "Source: TfL, London Data Store",
    x="week", 
    y="" ) +
  
  theme_bw()+
  
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),breaks = seq(-0.5, 1, by = 0.5))+
  scale_x_continuous(breaks=c(13,26,39,53))+
  
 geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change>0, percentage_change-0, 0)),fill="green",alpha=0.4)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change>0, 0,percentage_change-0)),fill="red",alpha=0.4) +
  
  geom_rug(sides="b",alpha=0.5, color=ifelse(bike9$actual_week_rental > bike9$weekly_mean_peryear, "green", "red"))+
  
  annotate("rect", xmin = 14, xmax = 26, ymin = -1, ymax = 1, fill = "grey", alpha=0.25) +
  annotate("rect", xmin = 40, xmax = 52,ymin = -1, ymax = 1, fill = "grey",alpha=0.25) +
  
  theme(panel.background = element_rect(colour="white",fill="white"), plot.background = element_rect(colour="black"))+
  theme_minimal() +
   NULL
  
```

## Should you use the mean or the median to calculate your expected rentals? Why?

**Answer: We should use median to calculate expected rentals because the data for Bike Rentals has several outliers that may skew the expected rentals calculation if we use the mean.**

The second one looks at percentage changes from the expected level of weekly rentals. The two grey shaded rectangles correspond to the second (weeks 14-26) and fourth (weeks 40-52) quarters.

```{r tfl_percent_change, echo=FALSE, out.width="100%"}

knitr::include_graphics(here::here("images", "tfl_weekly.png"), error = FALSE)

bike5 <- bike %>% 
  mutate(date=ymd(day),WEEK=isoweek(date)) %>%
  filter(year>=2016 & year <=2019)  %>%
  dplyr::group_by(WEEK) %>%
  dplyr::summarize(weekly_mean_peryear=mean(bikes_hired)) 

bike6 <- bike %>%
  mutate(date=ymd(day),WEEK=isoweek(date)) %>%
  filter(year>=2016)  %>%
  dplyr::group_by(WEEK,year) %>%
  dplyr::summarize(actual_week_rental=mean(bikes_hired))

bike7 <- left_join(bike5, bike6, by ="WEEK")
bike8 <- bike7 %>%
  mutate(percentage_change=actual_week_rental/weekly_mean_peryear-1)


bike9 <- head(bike8,-1) #cleaning week 53 of 2021 (outlier)
  
bike9 %>%
  ggplot(aes(x=WEEK,y=percentage_change)) +
  geom_line(colour="black",size=0.3)+
  facet_wrap(~year,nrow=2)+
    labs(title = "Weekly changes in Tfl bike rentals", 
    subtitle = "% change from weekly averages calculated between 2016-2019",   caption= "Source: TfL, London Data Store",
    x="week", 
    y="" ) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),breaks = seq(0, 1, by = 0.5))+
 geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change>0, percentage_change-0, 0)),fill="green",alpha=0.4)+
  geom_ribbon(aes(xmin = 0, xmax = Inf,ymin=0,ymax=0+ifelse(percentage_change>0, 0,percentage_change-0)),fill="red",alpha=0.4) +
   theme(panel.background = element_rect(colour="white",fill="white"), plot.background = element_rect(colour="black"))+
   NULL
  
```

For both of these graphs, you have to calculate the expected number of rentals per week or month between 2016-2019 and then, see how each week/month of 2020-2021 compares to the expected rentals. Think of the calculation `excess_rentals = actual_rentals - expected_rentals`. 

Should you use the mean or the median to calculate your expected rentals? Why?

**Answer: We should use median to calculate expected rentals because the data for Bike Rentals has several outliers that may skew the expected rentals calculation if we use the mean.**